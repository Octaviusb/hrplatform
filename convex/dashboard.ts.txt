import { v } from "convex/values";
import { query } from "./_generated/server";
import { ConvexError } from "convex/values";

export const getStats = query({
  args: {},
  handler: async (ctx) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new ConvexError({
        message: "Usuario no autenticado",
        code: "UNAUTHENTICATED",
      });
    }

    const user = await ctx.db
      .query("users")
      .withIndex("by_token", (q) =>
        q.eq("tokenIdentifier", identity.tokenIdentifier),
      )
      .unique();

    if (!user || !user.organizationId) {
      return {
        totalEmployees: 0,
        totalDepartments: 0,
        totalPositions: 0,
        activeVacations: 0,
        pendingInterviews: 0,
        activeDevelopmentPlans: 0,
        totalCourses: 0,
        pendingPayroll: 0,
      };
    }

    const [
      employees,
      departments,
      positions,
      vacations,
      interviews,
      developmentPlans,
      courses,
      payroll,
    ] = await Promise.all([
      ctx.db
        .query("employees")
        .withIndex("by_organization", (q) =>
          q.eq("organizationId", user.organizationId!),
        )
        .filter((q) => q.eq(q.field("status"), "active"))
        .collect(),
      ctx.db
        .query("departments")
        .withIndex("by_organization", (q) =>
          q.eq("organizationId", user.organizationId!),
        )
        .collect(),
      ctx.db
        .query("positions")
        .withIndex("by_organization", (q) =>
          q.eq("organizationId", user.organizationId!),
        )
        .collect(),
      ctx.db
        .query("vacations")
        .withIndex("by_organization", (q) =>
          q.eq("organizationId", user.organizationId!),
        )
        .filter((q) => q.eq(q.field("status"), "approved"))
        .collect(),
      ctx.db
        .query("interviews")
        .withIndex("by_organization", (q) =>
          q.eq("organizationId", user.organizationId!),
        )
        .filter((q) => q.eq(q.field("status"), "scheduled"))
        .collect(),
      ctx.db
        .query("developmentPlans")
        .withIndex("by_organization", (q) =>
          q.eq("organizationId", user.organizationId!),
        )
        .filter((q) => q.eq(q.field("status"), "active"))
        .collect(),
      ctx.db
        .query("courses")
        .withIndex("by_organization", (q) =>
          q.eq("organizationId", user.organizationId!),
        )
        .filter((q) => q.eq(q.field("status"), "scheduled"))
        .collect(),
      ctx.db
        .query("payroll")
        .withIndex("by_organization", (q) =>
          q.eq("organizationId", user.organizationId!),
        )
        .filter((q) => q.eq(q.field("status"), "draft"))
        .collect(),
    ]);

    return {
      totalEmployees: employees.length,
      totalDepartments: departments.length,
      totalPositions: positions.length,
      activeVacations: vacations.length,
      pendingInterviews: interviews.length,
      activeDevelopmentPlans: developmentPlans.length,
      totalCourses: courses.length,
      pendingPayroll: payroll.length,
    };
  },
});

export const getRecentActivity = query({
  args: {},
  handler: async (ctx) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) {
      throw new ConvexError({
        message: "Usuario no autenticado",
        code: "UNAUTHENTICATED",
      });
    }

    const user = await ctx.db
      .query("users")
      .withIndex("by_token", (q) =>
        q.eq("tokenIdentifier", identity.tokenIdentifier),
      )
      .unique();

    if (!user || !user.organizationId) {
      return [];
    }

    // Get recent observations
    const recentObservations = await ctx.db
      .query("observations")
      .withIndex("by_organization", (q) =>
        q.eq("organizationId", user.organizationId!),
      )
      .order("desc")
      .take(5);

    const activities = await Promise.all(
      recentObservations.map(async (obs) => {
        const employee = await ctx.db.get(obs.employeeId);
        const observer = await ctx.db.get(obs.observedBy);
        return {
          id: obs._id,
          type: "observation" as const,
          description: `${observer?.firstName || "Alguien"} registró una observación para ${employee?.firstName || "empleado"}`,
          date: obs.date,
        };
      }),
    );

    return activities;
  },
});
