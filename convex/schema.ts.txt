import { defineSchema, defineTable } from "convex/server";
import { v } from "convex/values";

export default defineSchema({
  users: defineTable({
    tokenIdentifier: v.string(),
    name: v.optional(v.string()),
    email: v.optional(v.string()),
    role: v.union(v.literal("admin"), v.literal("manager"), v.literal("employee")),
    organizationId: v.optional(v.id("organizations")),
  }).index("by_token", ["tokenIdentifier"])
    .index("by_organization", ["organizationId"]),

  organizations: defineTable({
    name: v.string(),
    nit: v.string(),
    address: v.optional(v.string()),
    phone: v.optional(v.string()),
    email: v.optional(v.string()),
    industry: v.optional(v.string()),
    size: v.union(v.literal("small"), v.literal("medium"), v.literal("large")),
    createdById: v.id("users"),
  }).index("by_nit", ["nit"]),

  departments: defineTable({
    name: v.string(),
    description: v.optional(v.string()),
    organizationId: v.id("organizations"),
    managerId: v.optional(v.id("employees")),
  }).index("by_organization", ["organizationId"]),

  positions: defineTable({
    title: v.string(),
    description: v.optional(v.string()),
    departmentId: v.id("departments"),
    level: v.optional(v.string()),
    organizationId: v.id("organizations"),
  }).index("by_department", ["departmentId"])
    .index("by_organization", ["organizationId"]),

  employees: defineTable({
    userId: v.id("users"),
    organizationId: v.id("organizations"),
    employeeNumber: v.string(),
    firstName: v.string(),
    lastName: v.string(),
    email: v.string(),
    phone: v.optional(v.string()),
    identificationNumber: v.string(),
    identificationType: v.union(v.literal("CC"), v.literal("CE"), v.literal("PA")),
    departmentId: v.optional(v.id("departments")),
    positionId: v.optional(v.id("positions")),
    hireDate: v.number(),
    status: v.union(v.literal("active"), v.literal("inactive"), v.literal("suspended")),
    salary: v.optional(v.number()),
    vacationDays: v.number(),
  }).index("by_user", ["userId"])
    .index("by_organization", ["organizationId"])
    .index("by_department", ["departmentId"])
    .index("by_employee_number", ["employeeNumber"]),

  observations: defineTable({
    employeeId: v.id("employees"),
    observedBy: v.id("employees"),
    organizationId: v.id("organizations"),
    type: v.union(v.literal("formal"), v.literal("informal")),
    category: v.string(),
    content: v.string(),
    rating: v.optional(v.number()),
    date: v.number(),
  }).index("by_employee", ["employeeId"])
    .index("by_organization", ["organizationId"]),

  interviews: defineTable({
    employeeId: v.id("employees"),
    interviewedBy: v.id("employees"),
    organizationId: v.id("organizations"),
    type: v.union(
      v.literal("performance"),
      v.literal("feedback"),
      v.literal("development"),
      v.literal("disciplinary")
    ),
    scheduledDate: v.number(),
    completedDate: v.optional(v.number()),
    status: v.union(v.literal("scheduled"), v.literal("completed"), v.literal("cancelled")),
    notes: v.optional(v.string()),
    outcome: v.optional(v.string()),
  }).index("by_employee", ["employeeId"])
    .index("by_organization", ["organizationId"]),

  jobAnalysis: defineTable({
    positionId: v.id("positions"),
    organizationId: v.id("organizations"),
    purpose: v.string(),
    essentialFunctions: v.array(v.string()),
    organizationalContext: v.optional(v.string()),
    requiredCompetencies: v.array(v.object({
      competency: v.string(),
      level: v.string(),
    })),
    performanceExpectations: v.optional(v.string()),
    createdBy: v.id("employees"),
  }).index("by_position", ["positionId"])
    .index("by_organization", ["organizationId"]),

  developmentPlans: defineTable({
    employeeId: v.id("employees"),
    organizationId: v.id("organizations"),
    title: v.string(),
    description: v.string(),
    goals: v.array(v.object({
      goal: v.string(),
      deadline: v.number(),
      status: v.union(v.literal("pending"), v.literal("in_progress"), v.literal("completed")),
    })),
    activities: v.array(v.object({
      activity: v.string(),
      type: v.string(),
      completed: v.boolean(),
    })),
    startDate: v.number(),
    endDate: v.number(),
    status: v.union(v.literal("draft"), v.literal("active"), v.literal("completed")),
    createdBy: v.id("employees"),
  }).index("by_employee", ["employeeId"])
    .index("by_organization", ["organizationId"]),

  vacations: defineTable({
    employeeId: v.id("employees"),
    organizationId: v.id("organizations"),
    startDate: v.number(),
    endDate: v.number(),
    days: v.number(),
    status: v.union(v.literal("pending"), v.literal("approved"), v.literal("rejected")),
    requestedDate: v.number(),
    approvedBy: v.optional(v.id("employees")),
    approvedDate: v.optional(v.number()),
    comments: v.optional(v.string()),
  }).index("by_employee", ["employeeId"])
    .index("by_organization", ["organizationId"]),

  attendance: defineTable({
    employeeId: v.id("employees"),
    organizationId: v.id("organizations"),
    date: v.number(),
    checkIn: v.optional(v.number()),
    checkOut: v.optional(v.number()),
    hoursWorked: v.optional(v.number()),
    overtimeHours: v.optional(v.number()),
    status: v.union(v.literal("present"), v.literal("absent"), v.literal("late"), v.literal("half_day")),
  }).index("by_employee", ["employeeId"])
    .index("by_organization", ["organizationId"])
    .index("by_date", ["date"]),

  payroll: defineTable({
    employeeId: v.id("employees"),
    organizationId: v.id("organizations"),
    period: v.string(),
    periodStart: v.number(),
    periodEnd: v.number(),
    baseSalary: v.number(),
    bonuses: v.number(),
    deductions: v.number(),
    netSalary: v.number(),
    status: v.union(v.literal("draft"), v.literal("processed"), v.literal("paid")),
    paymentDate: v.optional(v.number()),
    dianStatus: v.optional(v.union(v.literal("pending"), v.literal("sent"), v.literal("accepted"), v.literal("rejected"))),
    cune: v.optional(v.string()),
  }).index("by_employee", ["employeeId"])
    .index("by_organization", ["organizationId"])
    .index("by_period", ["period"]),

  jobPostings: defineTable({
    organizationId: v.id("organizations"),
    positionId: v.id("positions"),
    title: v.string(),
    description: v.string(),
    requirements: v.array(v.string()),
    responsibilities: v.array(v.string()),
    salaryRange: v.optional(v.object({
      min: v.number(),
      max: v.number(),
    })),
    status: v.union(v.literal("draft"), v.literal("published"), v.literal("closed")),
    publishedDate: v.optional(v.number()),
    closedDate: v.optional(v.number()),
    createdBy: v.id("employees"),
  }).index("by_organization", ["organizationId"])
    .index("by_position", ["positionId"]),

  candidates: defineTable({
    jobPostingId: v.id("jobPostings"),
    organizationId: v.id("organizations"),
    firstName: v.string(),
    lastName: v.string(),
    email: v.string(),
    phone: v.optional(v.string()),
    resume: v.optional(v.string()),
    status: v.union(
      v.literal("applied"),
      v.literal("screening"),
      v.literal("interview"),
      v.literal("offer"),
      v.literal("hired"),
      v.literal("rejected")
    ),
    appliedDate: v.number(),
    notes: v.optional(v.string()),
  }).index("by_job_posting", ["jobPostingId"])
    .index("by_organization", ["organizationId"]),

  courses: defineTable({
    organizationId: v.id("organizations"),
    title: v.string(),
    description: v.string(),
    instructor: v.optional(v.string()),
    duration: v.number(),
    capacity: v.optional(v.number()),
    startDate: v.number(),
    endDate: v.number(),
    status: v.union(v.literal("scheduled"), v.literal("in_progress"), v.literal("completed"), v.literal("cancelled")),
    type: v.union(v.literal("technical"), v.literal("leadership"), v.literal("compliance"), v.literal("other")),
    createdBy: v.id("employees"),
  }).index("by_organization", ["organizationId"]),

  enrollments: defineTable({
    courseId: v.id("courses"),
    employeeId: v.id("employees"),
    organizationId: v.id("organizations"),
    enrolledDate: v.number(),
    status: v.union(v.literal("enrolled"), v.literal("in_progress"), v.literal("completed"), v.literal("dropped")),
    completionDate: v.optional(v.number()),
    grade: v.optional(v.number()),
    certificateIssued: v.boolean(),
  }).index("by_course", ["courseId"])
    .index("by_employee", ["employeeId"])
    .index("by_organization", ["organizationId"]),
});
